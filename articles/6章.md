## 6章

## 6-6 理解mvvm


 ViewModel 的理解，联系 View 和 Model	
	
![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/6.png)

view 可以通过数据绑定，影响到 model  
model 可以通过事件绑定，影响到 view   


## 6-11 响应式

响应式：vue 如何监听到 data 的每个属性变化？  模板引擎：vue 的模板如何被解析，指令如何处理？  渲染：vue 的模板如何被渲染成 html ？以及渲染过程  	
响应式： defineProperty

```
var vm = {}
var data = {
    name: 'zhangsan',
    age: 20
}

var key, value
for (key in data) {
    (function (key) {
        Object.defineProperty(vm, key, {
            get: function () {
                console.log('get', data[key]) // 监听
                return data[key]
            },
            set: function (newVal) {
                console.log('set', newVal) // 监听
                data[key] = newVal
            }
        })
    })(key)
}
```


	view 的响应式是怎么回事？
关键点：

	关键是理解 Object.defineProperty	将 data 的属性代理到 vm 上


![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/7.png)





defineProperty 解析：

对象 某个属性的 配置，      
对象 o 拥有 name属性，可以获取值、修改值

```

Object.defineProperty(o, 'name', {
  value: 1,
  writable: true,      是否可以被重写
  configurable: true,  目标属性是否可以被删除或是否可以再次修改特性
  enumerable: true,  // 是否可以枚举 for in object.keys
  get : function(){
    return bValue;
  },
  set : function(newValue){
    bValue = newValue;
  },
});

```

## 6-14 模板引擎


1. 模板是什么  2. render 函数  3. render 函数与 vdom  


#### 模板是什么

+ 模板就是 .vue 文件写的 类似html的代码， 本质：字符串  + 有逻辑，如 v-if v-for 等，能判断，能循环  
+ 模板最终还要转换为 html 来显示  

#### 模板最终必须转换成 JS 代码，因为：  
+ 有逻辑（v-if v-for），必须用 JS 才能实现（图灵完备 )
+ 转换为 html 渲染页面，必须用 JS 才能实现
+ 因此，模板最重要转换成一个 render 函数



### render 函数

 with 函数的作用， 通过with 取代 对象的属性读取 . 操作
 
 ```
 var obj = {
 	name: 'zhangsan'
 }
 
 function fn(){
 	console.log(obj.name)
 }
 
 function fn(){
 	with(obj){
 		console.log(name)
 	}
 }
 ```

怎么感觉 render 函数和 h 函数差不多？知识返回的 是一个函数 _c()


this: vm 对象

```
<div id="app">
    <p>{{price}}</p>
</div>
    
    

function render() {
    with(this) {  // this 就是 vm
        return _c(
            'div',
            {
                attrs: {'id': 'app'}
            },
            [
                _c('p', [_v(_s(price))])
            ]
        )
    }
}

```


![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/8.png)
 
_c 函数，生成dom节点  
	
	vm._c 其实就相当于 snabbdom 中的 h 函数
	render 函数执行之后，返回的是 vnode
_v ？？  

	function  createTextVnode(val)
	创建文本节点函数
	
_s ??  

	toString 函数
	function toString()




## 6-19 render 函数详细

从哪里可以看到 render 函数？  
复杂一点的例子，render 函数是什么样子的？  
vm._c 是什么？   为什么模板必须要转换成js？
	
	模板中有大量v-for,v-if 逻辑处理，模板必须转成html渲染，这些都必须转成js才能实现```this._c = function (a, b, c, d) {
  var vnode = createElement(contextVm, a, b, c, d, needNormalization);
  if (vnode) {
    vnode.fnScopeId = options._scopeId;
    vnode.fnContext = parent;
  }
  return vnode
};this._v =  function createTextVNode (val) {
  return new VNode(undefined, undefined, undefined, String(val))
}

this._s = Object.prototype.toString;
```
### v-for render 是如何处理逻辑的？



 vue2.0 开始，支持预编译，
 编译打包后，在生产环境下，就是js代码
 
根据 todo-list demo 的 render 函数：v-model 是怎么实现的？

![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/9.png)

	v-model 双向绑定，既能get , 也能set
	可以通过看到render函数，监听 input 函数
	
v-on:click 是怎么实现的？
	
	_c(
	'button',
		{
			on: {
				'click': add
			}
		}
	)v-for 是怎么实现的？
	
	_c('div', [
		_c(
			'ul',
			_l((list), function(item){ return _c('li', [_v(_s(item))])} )
		) 
	])
	


### vm._c 返回了什么，render函数返回了什么

vm._c 其实就相当于 snabbdom 中的 h 函数render 函数执行之后，返回的是 vnode 



updateComponent 中实现了 vdom 的 patch页面首次渲染执行 updateComponentdata 中每次修改属性，执行 updateComponent

![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/10.png)


如何实时监听的？ 
	
> 在 vm 的 defineproperty 每个属性的 set函数， 调用 updateComponent, 生成新的 vnode 树， 然后执行 patch 函数



## 6-25 整体流程，重要！可以再看一遍

第一步：解析模板成 render 函数

第二步：响应式开始监听
	
	Object.defineProperty
	将 data 的属性代理到 vm 上

第三步：首次渲染，显示页面，且绑定依赖

主要理解，在render中访问vm的属性，如 with(this)  title 
这个时候回被get监听到

	1. 初次渲染，执行 updateComponent，执行 vm._render()
	2. 执行 render 函数，会访问到 vm.list vm.title
	3. 会被响应式的 get 方法监听到
	4. 执行 updateComponent ，会走到 vdom 的 patch 方法
	5. patch 将 vnode 渲染成 DOM ，初次渲染完成

第四步：data 属性变化，触发 rerender
	
	修改属性，被响应式的 set 监听到
	set 中执行 updateComponent
	updateComponent 重新执行 vm._render()
	生成的 vnode 和 prevVnode ，通过 patch 进行对比
	渲染到 html 中

render 函数

![img](https://github.com/shipskunkun/interview-tips2/blob/master/images/11.png)


必须走get才能走set? 如何理解

如果不被get监听，说明模板render函数中没有这个变量，模板中没有使用这个变量，所以不会在set中监听


## 6-28 总结

模板是什么：
	
	字符串，有逻辑，嵌入了js变量
为什么转成js代码
	
	有逻辑，渲染html，js变量



